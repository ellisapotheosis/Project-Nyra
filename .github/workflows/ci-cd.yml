name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.11"
  UV_CACHE_DIR: ~/.cache/uv
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ” Code Quality & Security
  quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    outputs:
      python-cache-key: ${{ steps.cache-key.outputs.python-cache-key }}
    
    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: ðŸ Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install dependencies
      run: |
        uv sync --group lint --group dev
        echo "VIRTUAL_ENV=$(uv venv --python ${{ env.PYTHON_VERSION }} --seed)" >> $GITHUB_ENV

    - name: ðŸ§¹ Run ruff (lint)
      run: uv run ruff check . --output-format=github

    - name: ðŸŽ¨ Run ruff (format check)
      run: uv run ruff format --check . --diff

    - name: ðŸ” Run mypy type checking
      run: uv run mypy src/ --ignore-missing-imports --show-error-codes

    - name: ðŸ”’ Run bandit security linter
      run: |
        uv add --dev bandit[toml]
        uv run bandit -r src/ -f json -o bandit-report.json -ll
      continue-on-error: true

    - name: ðŸ“Š Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-bandit-report
        path: bandit-report.json

    - name: ðŸ” Run safety check
      run: |
        uv add --dev safety
        uv run safety check --json --output safety-report.json
      continue-on-error: true

    - name: ðŸ“Š Upload safety report  
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-safety-report
        path: safety-report.json

  # ðŸ§ª Comprehensive Testing
  test:
    name: ðŸ§ª Tests (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.11", "3.12"]
        include:
          - os: macos-latest
            python-version: "3.11"

    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: ðŸ Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: ðŸ“¦ Install dependencies
      run: uv sync --group test --group mcp --group agents

    - name: ðŸ§ª Run pytest with coverage
      run: |
        uv run pytest tests/ -v \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=pytest-results.xml \
          --maxfail=3
      env:
        PYTHONPATH: src

    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          pytest-results.xml
          htmlcov/
          coverage.xml

    - name: ðŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  # ðŸ”Œ MCP Server Testing
  test-mcp:
    name: ðŸ”Œ MCP Server Tests
    runs-on: ubuntu-latest
    needs: quality
    
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Install uv  
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: ðŸ Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install MCP dependencies
      run: uv sync --group mcp --group test

    - name: ðŸ”Œ Test MCP servers
      run: |
        uv run python -m pytest tests/mcp/ -v \
          --cov=mcp \
          --cov-report=xml \
          --junitxml=mcp-test-results.xml
      env:
        QDRANT_URL: http://localhost:6333
        PYTHONPATH: src

    - name: ðŸ“Š Upload MCP test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mcp-test-results
        path: |
          mcp-test-results.xml
          coverage.xml

  # ðŸ—ï¸ Build & Package
  build:
    name: ðŸ—ï¸ Build Package  
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'release'

    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: ðŸ Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install dependencies
      run: uv sync

    - name: ðŸ—ï¸ Build package
      run: uv build

    - name: ðŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-package
        path: dist/
        retention-days: 30

    - name: ðŸ³ Build Docker images (if Dockerfile exists)
      if: hashFiles('Dockerfile') != ''
      run: |
        docker build -t nyra-app:${{ github.sha }} .
        docker tag nyra-app:${{ github.sha }} nyra-app:latest

  # ðŸš€ Deploy to Staging
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, test-mcp]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging

    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-package
        path: dist/

    - name: ðŸš€ Deploy to staging
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        echo "ðŸ“¦ Package files:"
        ls -la dist/
        # Add your staging deployment commands here
        # Examples:
        # - Deploy to staging server via SSH
        # - Update staging Docker containers  
        # - Deploy to cloud staging environment
      env:
        STAGING_API_KEY: ${{ secrets.STAGING_API_KEY }}
        STAGING_URL: ${{ secrets.STAGING_URL }}

  # ðŸŒŸ Deploy to Production  
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test-mcp]
    if: github.event_name == 'release' && github.event.action == 'published'
    environment: production

    steps:
    - name: ðŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-package  
        path: dist/

    - name: ðŸŒŸ Deploy to production
      run: |
        echo "ðŸŒŸ Deploying to production environment..."
        echo "ðŸ“¦ Package files:"
        ls -la dist/
        # Add your production deployment commands here
        # Examples:
        # - Deploy to production servers
        # - Update production containers
        # - Deploy to cloud production environment
      env:
        PRODUCTION_API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
        PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}

  # ðŸ“ Generate Reports
  report:
    name: ðŸ“ Generate Reports
    runs-on: ubuntu-latest
    needs: [test, test-mcp]
    if: always()

    steps:
    - name: ðŸ“Š Download all artifacts
      uses: actions/download-artifact@v4

    - name: ðŸ“ Generate workflow summary
      run: |
        echo "# ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code linting and formatting" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Type checking with mypy" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security scanning" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Multi-platform testing completed" >> $GITHUB_STEP_SUMMARY
        echo "- MCP server testing completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Build & Deploy" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          echo "- ðŸš€ Staging deployment triggered" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          echo "- ðŸŒŸ Production deployment triggered" >> $GITHUB_STEP_SUMMARY  
        else
          echo "- ðŸ—ï¸ Build completed (no deployment)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“Š Comment PR with results (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('ðŸ¤– NYRA CI/CD Results')
          );
          
          const body = `## ðŸ¤– NYRA CI/CD Results
          
          ### âœ… Quality & Security Checks
          - Code linting and formatting âœ…
          - Type checking with mypy âœ…  
          - Security scanning completed âœ…
          
          ### ðŸ§ª Test Results  
          - Multi-platform tests âœ…
          - MCP server tests âœ…
          - Coverage reports generated âœ…
          
          ### ðŸ“¦ Build Status
          - Package build successful âœ…
          
          _Last updated: ${new Date().toISOString()}_`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }